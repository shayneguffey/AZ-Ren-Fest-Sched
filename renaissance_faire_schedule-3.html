<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Renaissance Faire ‚Äì Master Schedule</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Cinzel:wght@400;600&family=IM+Fell+English:ital@0;1&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --parchment:       #f2e0b0;
    --parchment-dark:  #dfc98a;
    --parchment-deep:  #c9a84c;
    --ink:             #1e0f00;
    --ink-mid:         #3a1f00;
    --crimson:         #7a1515;
    --gold:            #b8892a;
    --gold-bright:     #d4a83c;
    --gold-light:      #e8c96e;
    --forest:          #1e3d18;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    background: #0e0800;
    background-image:
      radial-gradient(ellipse at 15% 10%, rgba(122,21,21,0.2) 0%, transparent 45%),
      radial-gradient(ellipse at 85% 90%, rgba(30,61,24,0.2) 0%, transparent 45%);
  }

  .page-wrapper {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 16px 60px;
  }

  /* ‚ïê‚ïê HEADER ‚ïê‚ïê */
  .header {
    text-align: center;
    padding: 28px 20px 20px;
    background: linear-gradient(180deg, #1a0900 0%, #0e0800 100%);
  }

  .header-rule {
    display: flex;
    align-items: center;
    margin-bottom: 14px;
  }
  .header-rule-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--gold), var(--crimson), var(--gold-bright), var(--crimson), var(--gold), transparent);
  }
  .header-rule-diamond {
    width: 10px; height: 10px;
    background: var(--gold-bright);
    transform: rotate(45deg);
    margin: 0 8px;
    flex-shrink: 0;
    box-shadow: 0 0 8px rgba(212,168,60,0.7);
  }

  .header-crests {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-bottom: 6px;
  }

  .crest-svg { opacity: 0.88; filter: drop-shadow(0 0 6px rgba(212,168,60,0.4)); }

  .header-band {
    border-left: 1px solid rgba(184,137,42,0.3);
    border-right: 1px solid rgba(184,137,42,0.3);
    padding: 8px 36px 12px;
    display: inline-block;
  }

  .header h1 {
    font-family: 'Cinzel Decorative', cursive;
    font-size: clamp(22px, 4vw, 44px);
    color: var(--gold-light);
    letter-spacing: 4px;
    line-height: 1.15;
    text-shadow: 0 0 40px rgba(212,168,60,0.5), 2px 2px 0 rgba(0,0,0,0.7);
    margin-bottom: 4px;
  }

  .drop-initial {
    display: inline-block;
    font-family: 'Cinzel Decorative', cursive;
    font-size: clamp(44px, 6.5vw, 68px);
    color: var(--crimson);
    text-shadow: 2px 2px 0 rgba(0,0,0,0.8), 0 0 20px rgba(168,32,32,0.4);
    line-height: 0.75;
    vertical-align: middle;
    margin-right: 2px;
  }

  .header-subtitle {
    font-family: 'Cinzel', serif;
    color: var(--parchment-dark);
    font-size: 11px;
    letter-spacing: 5px;
    text-transform: uppercase;
    opacity: 0.72;
    margin-bottom: 14px;
  }

  /* ‚ïê‚ïê SCROLL ROLLERS ‚ïê‚ïê */
  .scroll-roller {
    height: 20px;
    background: linear-gradient(180deg,
      #2a1400 0%, #6a3a08 18%, #b87808 44%, #d4a020 50%,
      #b87808 56%, #6a3a08 82%, #1e0e00 100%);
    border-radius: 2px;
    position: relative;
    box-shadow: 0 3px 14px rgba(0,0,0,0.75), inset 0 1px 0 rgba(255,220,100,0.25);
    z-index: 2;
  }
  .scroll-roller::before, .scroll-roller::after {
    content: '';
    position: absolute;
    top: 50%; transform: translateY(-50%);
    width: 30px; height: 30px;
    background: radial-gradient(circle at 38% 38%, #e0a020 0%, #8a4800 55%, #2e1400 100%);
    border-radius: 50%;
    border: 2px solid #d4a838;
    box-shadow: 0 2px 8px rgba(0,0,0,0.65);
  }
  .scroll-roller::before { left: -5px; }
  .scroll-roller::after  { right: -5px; }

  /* ‚ïê‚ïê PARCHMENT BODY ‚ïê‚ïê */
  .scroll-body {
    background:
      repeating-linear-gradient(0deg,   transparent 0px, transparent 4px, rgba(140,90,20,0.035) 4px, rgba(140,90,20,0.035) 5px),
      repeating-linear-gradient(90deg,  transparent 0px, transparent 9px, rgba(120,75,15,0.025) 9px, rgba(120,75,15,0.025) 10px),
      linear-gradient(165deg, #f6ecc4 0%, #eee0a8 18%, #e8d490 38%, #ecdea0 56%, #e4d088 74%, #dac47a 100%);
    border-left:  7px solid transparent;
    border-right: 7px solid transparent;
    border-image: linear-gradient(180deg, rgba(90,50,5,0.85), rgba(160,100,15,0.65), rgba(90,50,5,0.85)) 1;
    position: relative;
    box-shadow:
      inset  4px 0 16px rgba(90,50,5,0.28),
      inset -4px 0 16px rgba(90,50,5,0.28),
      inset  0  5px 20px rgba(90,50,5,0.18),
      inset  0 -5px 20px rgba(90,50,5,0.18);
  }

  /* Side margin vines */
  .margin-vines {
    position: absolute;
    top: 0; bottom: 0;
    width: 22px;
    pointer-events: none;
    z-index: 3;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-around;
    padding: 10px 0;
    font-size: 11px;
    color: rgba(30,61,24,0.65);
    overflow: hidden;
  }
  .margin-vines.left  { left: 7px; }
  .margin-vines.right { right: 7px; transform: scaleX(-1); }
  .margin-vines::before {
    content: '';
    position: absolute;
    top: 0; bottom: 0; left: 50%;
    width: 1px;
    background: repeating-linear-gradient(180deg,
      rgba(30,61,24,0.5) 0px, rgba(30,61,24,0.5) 5px,
      transparent 5px, transparent 9px
    );
  }

  /* ‚ïê‚ïê CONTROLS ‚ïê‚ïê */
  .controls-wrap {
    padding: 10px 36px 8px;
    border-bottom: 1px solid rgba(140,90,20,0.28);
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    background: rgba(180,140,50,0.08);
  }

  .controls-label {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--ink-mid);
    text-transform: uppercase;
    opacity: 0.65;
    white-space: nowrap;
  }

  .search-wrap {
    position: relative;
    flex: 1;
    min-width: 180px;
  }

  .search-wrap input {
    width: 100%;
    background: rgba(242,224,176,0.65);
    border: 1px solid rgba(140,90,20,0.55);
    color: var(--ink);
    font-family: 'Inter', sans-serif;
    font-size: 13px;
    padding: 7px 12px 7px 30px;
    outline: none;
    transition: border-color 0.2s, background 0.2s;
    box-shadow: inset 0 1px 3px rgba(90,50,5,0.12);
  }
  .search-wrap input::placeholder { color: rgba(58,31,0,0.38); }
  .search-wrap input:focus {
    border-color: var(--gold);
    background: rgba(242,224,176,0.88);
  }
  .search-icon {
    position: absolute;
    left: 8px; top: 50%;
    transform: translateY(-50%);
    color: var(--gold);
    font-size: 13px;
    pointer-events: none;
  }

  .btn {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    letter-spacing: 1.5px;
    padding: 7px 14px;
    border: 1px solid rgba(140,90,20,0.55);
    background: rgba(180,140,50,0.12);
    color: var(--ink-mid);
    cursor: pointer;
    transition: all 0.18s;
    text-transform: uppercase;
  }
  .btn:hover {
    background: rgba(180,140,50,0.28);
    border-color: var(--gold);
    color: var(--ink);
  }

  /* ‚ïê‚ïê CHART ‚ïê‚ïê */
  .chart-container {
    overflow-x: auto;
    overflow-y: auto;
    max-height: calc(100vh - 220px);
    padding: 0 32px 0 0;
  }

  .chart-inner { min-width: 2200px; }

  .timeline-header {
    display: grid;
    grid-template-columns: 110px 1fr;
    border-bottom: 2px solid rgba(140,90,20,0.42);
    position: sticky;
    top: 0;
    z-index: 10;
    background: linear-gradient(180deg, rgba(228,206,130,0.98) 0%, rgba(215,190,108,0.98) 100%);
    box-shadow: 0 2px 8px rgba(90,50,5,0.2);
  }

  .stage-label-header {
    padding: 8px 10px;
    font-family: 'Cinzel', serif;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--crimson);
    border-right: 2px solid rgba(140,90,20,0.42);
    display: flex;
    align-items: center;
    position: sticky;
    left: 0;
    z-index: 11;
    background: linear-gradient(180deg, rgba(228,206,130,0.98) 0%, rgba(215,190,108,0.98) 100%);
    box-shadow: 3px 0 8px rgba(90,50,5,0.22);
  }

  .time-axis { position: relative; height: 38px; }

  .time-tick {
    position: absolute;
    top: 0;
    transform: translateX(-50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
  }
  .time-tick .tick-label {
    font-family: 'Cinzel', serif;
    font-size: 10px;
    font-weight: 600;
    color: var(--crimson);
    padding-top: 5px;
    white-space: nowrap;
  }
  .time-tick .tick-line {
    width: 1px; flex: 1;
    background: rgba(140,90,20,0.32);
    margin-top: 3px;
  }

  /* Alternating parchment rows */
  .chart-row {
    display: grid;
    grid-template-columns: 110px 1fr;
    border-bottom: 1px solid rgba(140,90,20,0.18);
    transition: background 0.15s;
    min-height: 64px;
  }
  .chart-row:nth-child(odd)  { background: rgba(238,214,142,0.55); }
  .chart-row:nth-child(even) { background: rgba(222,200,120,0.45); }
  .chart-row:hover            { background: rgba(190,150,50,0.24) !important; }
  .chart-row:last-child       { border-bottom: none; }

  .stage-name {
    padding: 6px 8px 6px 10px;
    font-family: 'Cinzel', serif;
    font-size: 13px;
    font-weight: 700;
    color: #3a0e0e;
    letter-spacing: 0.2px;
    border-right: 2px solid rgba(140,90,20,0.5);
    display: flex;
    align-items: center;
    line-height: 1.4;
    min-height: 64px;
    text-shadow: 0 1px 0 rgba(255,255,255,0.2);
    word-break: break-word;
    white-space: normal;
    position: sticky;
    left: 0;
    z-index: 3;
    background: inherit;
    box-shadow: 3px 0 8px rgba(90,50,5,0.22);
  }

  .bars-area {
    position: relative;
    height: 64px;
  }
  .bars-area::before {
    content: '';
    position: absolute; inset: 0;
    background-image: repeating-linear-gradient(
      90deg,
      rgba(140,90,20,0.1) 0px, rgba(140,90,20,0.1) 1px,
      transparent 1px, transparent calc(100% / 8)
    );
    pointer-events: none;
  }

  /* ‚ïê‚ïê EVENT BARS ‚ïê‚ïê */
  .event-bar {
    position: absolute;
    top: 50%; transform: translateY(-50%);
    height: 38px;
    border-radius: 2px;
    display: flex;
    align-items: center;
    padding: 3px 7px;
    overflow: hidden;
    cursor: pointer;
    transition: filter 0.15s, box-shadow 0.15s;
    z-index: 2;
    border: 1px solid rgba(0,0,0,0.22);
    box-shadow:
      0 2px 6px rgba(0,0,0,0.32),
      inset 0 1px 0 rgba(255,255,255,0.2),
      inset 0 -1px 0 rgba(0,0,0,0.14);
  }
  .event-bar:hover {
    filter: brightness(1.14) saturate(1.2);
    box-shadow: 0 4px 14px rgba(0,0,0,0.44), inset 0 1px 0 rgba(255,255,255,0.28);
    z-index: 20;
  }
  .event-bar-label {
    font-family: 'Inter', sans-serif;
    font-size: 10.5px;
    color: rgba(255,255,255,0.97);
    white-space: normal;
    overflow: hidden;
    word-break: break-word;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    pointer-events: none;
    text-shadow: 0 1px 3px rgba(0,0,0,0.78);
    font-weight: 500;
    line-height: 1.25;
  }

  .event-bar.dimmed     { opacity: 0.16; filter: grayscale(0.55); }
  .event-bar.highlighted {
    filter: brightness(1.18) saturate(1.25);
    z-index: 5;
    box-shadow: 0 0 0 2px var(--gold-bright), 0 4px 14px rgba(0,0,0,0.48);
  }

  .now-line {
    position: absolute; top: 0; width: 2px; height: 100%;
    background: rgba(175,18,18,0.8);
    z-index: 15; pointer-events: none;
    box-shadow: 0 0 6px rgba(175,18,18,0.55);
  }

  /* ‚ïê‚ïê ORNAMENT DIVIDER ‚ïê‚ïê */
  .ornament-divider {
    display: flex; align-items: center;
    padding: 6px 32px;
    background: rgba(180,140,50,0.06);
  }
  .ornament-line {
    flex: 1; height: 1px;
    background: linear-gradient(90deg, transparent, rgba(140,90,20,0.5), transparent);
  }
  .ornament-center {
    font-size: 15px; color: var(--gold);
    margin: 0 12px; opacity: 0.72;
    text-shadow: 0 0 6px rgba(212,168,60,0.4);
  }

  /* ‚ïê‚ïê TOOLTIP ‚ïê‚ïê */
  .tooltip {
    position: fixed;
    background: linear-gradient(135deg, #2a1200 0%, #180800 100%);
    border: 1px solid var(--gold);
    padding: 14px 16px 12px 14px;
    pointer-events: auto;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 1000;
    max-width: 300px;
    width: 300px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.82), inset 0 1px 0 rgba(212,168,60,0.12);
  }
  .tooltip::before {
    content: '‚öú';
    position: absolute;
    top: -12px; left: 50%;
    transform: translateX(-50%);
    font-size: 18px; color: var(--gold-bright);
    background: #180800; padding: 0 4px; line-height: 1;
  }
  .tooltip.visible { opacity: 1; }
  .tooltip-title {
    font-family: 'Cinzel', serif;
    font-size: 12px; color: var(--gold-light);
    margin-bottom: 5px; line-height: 1.4; font-weight: 600;
  }
  .tooltip-meta {
    font-family: 'Inter', sans-serif;
    font-size: 11px; color: var(--parchment-dark); line-height: 1.7;
    margin-bottom: 6px;
  }
  .tooltip-blurb {
    font-family: 'IM Fell English', serif;
    font-size: 11.5px; color: rgba(245,224,176,0.88);
    line-height: 1.55; margin-bottom: 7px;
    border-top: 1px solid rgba(184,137,42,0.2);
    padding-top: 7px;
  }
  .tooltip-link {
    display: inline-block;
    font-family: 'Cinzel', serif;
    font-size: 9.5px; color: var(--gold-bright);
    letter-spacing: 1px; text-transform: uppercase;
    text-decoration: none;
    border: 1px solid rgba(184,137,42,0.4);
    padding: 3px 8px;
    margin-top: 2px;
    pointer-events: auto;
    transition: background 0.15s;
  }
  .tooltip-link:hover { background: rgba(212,168,60,0.15); }
  .tooltip-stage {
    font-family: 'Cinzel', serif;
    font-size: 9px; color: var(--parchment-deep);
    letter-spacing: 1.5px; text-transform: uppercase;
    margin-top: 6px; opacity: 0.6;
    border-top: 1px solid rgba(184,137,42,0.2);
    padding-top: 5px;
  }

  /* ‚ïê‚ïê FOOTER ‚ïê‚ïê */
  .footer {
    text-align: center;
    margin-top: 22px;
    font-family: 'Cinzel', serif;
    font-size: 10px; letter-spacing: 2.5px;
    color: rgba(184,137,42,0.45); text-transform: uppercase;
  }

  /* ‚ïê‚ïê FAVORITES ‚ïê‚ïê */
  .filter-faves-btn {
    background: linear-gradient(135deg, #7a1515, #a01a1a);
    color: #f6ecc4; border: 1px solid rgba(212,168,60,0.5);
    font-family: 'Cinzel', serif; font-size: 11px;
    padding: 6px 14px; cursor: pointer; letter-spacing: 0.5px;
    transition: filter 0.15s;
  }
  .filter-faves-btn:hover { filter: brightness(1.2); }
  .filter-faves-btn.active { background: linear-gradient(135deg, #d4a020, #b8860b); color: #1a0800; }

  .star-overlay {
    position: absolute; top: 2px; right: 4px;
    font-size: 14px; line-height: 1; cursor: pointer;
    z-index: 10; pointer-events: auto;
    text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    transition: transform 0.15s;
    user-select: none;
  }
  .star-overlay:hover { transform: scale(1.3); }
  .event-bar.favorited { box-shadow: 0 0 0 2px #ffd700, 0 4px 14px rgba(0,0,0,0.5); }
  .event-bar.favorited .star-overlay { color: #ffd700; }
  .event-bar:not(.favorited) .star-overlay { color: rgba(255,255,255,0.35); }
  .event-bar.fave-dimmed { opacity: 0.12; filter: grayscale(0.7); }

  /* ‚ïê‚ïê PERFORMER LIST ‚ïê‚ïê */
  .performer-list-section {
    margin: 0 32px 40px 32px;
    font-family: 'Cinzel', serif;
  }
  .performer-list-header {
    text-align: center; padding: 18px 0 10px;
    font-family: 'Cinzel Decorative', serif;
    font-size: 20px; color: var(--crimson);
    letter-spacing: 2px;
    border-top: 2px solid rgba(140,90,20,0.35);
    margin-bottom: 4px;
    text-shadow: 0 1px 0 rgba(255,255,255,0.5);
  }
  .performer-list-sub {
    text-align: center; font-family: 'Inter', sans-serif;
    font-size: 12px; color: rgba(80,40,5,0.65);
    margin-bottom: 18px; letter-spacing: 0.3px;
  }
  .performer-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 14px;
  }
  .performer-card {
    background: linear-gradient(135deg, rgba(246,236,196,0.92) 0%, rgba(235,218,165,0.92) 100%);
    border: 1px solid rgba(140,90,20,0.25);
    border-radius: 3px;
    padding: 14px 16px 12px;
    position: relative;
    box-shadow: 0 2px 8px rgba(90,50,5,0.1);
    transition: box-shadow 0.15s;
  }
  .performer-card:hover { box-shadow: 0 4px 16px rgba(90,50,5,0.2); }
  .performer-card.is-fave {
    border-color: #d4a020;
    box-shadow: 0 0 0 2px rgba(212,168,60,0.4), 0 4px 16px rgba(90,50,5,0.15);
    background: linear-gradient(135deg, rgba(255,248,210,0.97) 0%, rgba(245,230,160,0.97) 100%);
  }
  .card-color-bar {
    position: absolute; top: 0; left: 0; right: 0; height: 4px;
    border-radius: 3px 3px 0 0;
  }
  .card-header {
    display: flex; align-items: flex-start;
    justify-content: space-between; gap: 8px;
    margin-bottom: 6px; margin-top: 4px;
  }
  .card-title {
    font-family: 'Cinzel', serif; font-size: 13px;
    font-weight: 700; color: #3a0e0e;
    line-height: 1.35; flex: 1;
  }
  .card-star-btn {
    font-size: 20px; cursor: pointer; line-height: 1;
    background: none; border: none; padding: 0;
    transition: transform 0.15s; flex-shrink: 0;
    user-select: none;
  }
  .card-star-btn:hover { transform: scale(1.25); }
  .performer-card.is-fave .card-star-btn { color: #d4a020; }
  .performer-card:not(.is-fave) .card-star-btn { color: rgba(140,90,20,0.3); }
  .card-meta {
    font-family: 'Inter', sans-serif; font-size: 10.5px;
    color: rgba(80,40,5,0.65); margin-bottom: 8px;
    letter-spacing: 0.2px;
  }
  .card-blurb {
    font-family: 'IM Fell English', serif; font-size: 12.5px;
    color: #3a2000; line-height: 1.6;
    margin-bottom: 8px;
  }
  .card-link {
    font-family: 'Cinzel', serif; font-size: 9.5px;
    color: #7a1515; letter-spacing: 1px;
    text-transform: uppercase; text-decoration: none;
    border-bottom: 1px solid rgba(122,21,21,0.3);
    padding-bottom: 1px;
    transition: color 0.15s, border-color 0.15s;
  }
  .card-link:hover { color: #a02020; border-color: rgba(160,32,32,0.6); }
  .card-times {
    margin-top: 8px; padding-top: 7px;
    border-top: 1px solid rgba(140,90,20,0.18);
    font-family: 'Inter', sans-serif; font-size: 10px;
    color: rgba(80,40,5,0.6); display: flex; flex-wrap: wrap; gap: 4px;
  }
  .card-time-pill {
    background: rgba(140,90,20,0.1); border: 1px solid rgba(140,90,20,0.2);
    border-radius: 10px; padding: 2px 8px;
    font-size: 10px; color: #5a3000;
  }


  /* ‚ïê‚ïê ITINERARY CALCULATOR ‚ïê‚ïê */
  .calc-itinerary-btn {
    background: linear-gradient(135deg, #1a5a3a, #2a7d52);
    color: #f6ecc4; border: 1px solid rgba(212,168,60,0.5);
    font-family: 'Cinzel', serif; font-size: 11px;
    padding: 6px 14px; cursor: pointer; letter-spacing: 0.5px;
    transition: filter 0.15s;
  }
  .calc-itinerary-btn:hover { filter: brightness(1.2); }
  .calc-itinerary-btn:disabled {
    opacity: 0.5; cursor: not-allowed;
    background: linear-gradient(135deg, #555, #666);
  }

  .itinerary-panel {
    margin: 20px 32px;
    background: linear-gradient(135deg, rgba(246,236,196,0.95) 0%, rgba(235,218,165,0.95) 100%);
    border: 2px solid rgba(140,90,20,0.4);
    border-radius: 4px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(90,50,5,0.2);
    display: none;
  }
  .itinerary-panel.visible { display: block; }

  .itinerary-header {
    font-family: 'Cinzel Decorative', serif;
    font-size: 18px; color: var(--crimson);
    letter-spacing: 1.5px; margin-bottom: 6px;
    text-align: center;
    text-shadow: 0 1px 0 rgba(255,255,255,0.5);
  }
  .itinerary-summary {
    font-family: 'Inter', sans-serif;
    font-size: 11px; color: rgba(80,40,5,0.7);
    text-align: center; margin-bottom: 16px;
    letter-spacing: 0.3px;
  }
  .itinerary-summary .count { font-weight: 700; color: #1a5a3a; }
  .itinerary-summary .skipped { color: #a02020; }

  .itinerary-timeline {
    display: flex; flex-direction: column; gap: 10px;
    margin-bottom: 14px;
  }
  .itinerary-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 14px;
    background: rgba(255,255,255,0.6);
    border: 1px solid rgba(140,90,20,0.2);
    border-radius: 3px;
    position: relative;
    transition: background 0.15s;
  }
  .itinerary-item:hover { background: rgba(255,255,255,0.85); }
  .itinerary-item::before {
    content: '';
    position: absolute; left: -2px; top: 0; bottom: 0;
    width: 4px; border-radius: 3px 0 0 3px;
  }
  .itinerary-number {
    font-family: 'Cinzel', serif; font-size: 16px;
    font-weight: 700; color: #1a5a3a;
    width: 24px; flex-shrink: 0; text-align: center;
  }
  .itinerary-time {
    font-family: 'Cinzel', serif; font-size: 12px;
    color: #5a3000; font-weight: 600;
    width: 80px; flex-shrink: 0;
  }
  .itinerary-details {
    flex: 1; min-width: 0;
  }
  .itinerary-name {
    font-family: 'Cinzel', serif; font-size: 13px;
    font-weight: 700; color: #3a0e0e;
    line-height: 1.3; margin-bottom: 2px;
  }
  .itinerary-location {
    font-family: 'Inter', sans-serif; font-size: 10px;
    color: rgba(80,40,5,0.65); letter-spacing: 0.2px;
  }

  .skipped-section {
    margin-top: 14px; padding-top: 14px;
    border-top: 1px solid rgba(140,90,20,0.25);
  }
  .skipped-header {
    font-family: 'Cinzel', serif; font-size: 11px;
    color: #a02020; letter-spacing: 1px;
    margin-bottom: 6px; text-transform: uppercase;
  }
  .skipped-list {
    font-family: 'Inter', sans-serif; font-size: 11px;
    color: rgba(80,40,5,0.7); line-height: 1.6;
  }

  .itinerary-actions {
    text-align: center; margin-top: 14px;
    padding-top: 14px; border-top: 1px solid rgba(140,90,20,0.25);
  }
  .itinerary-close-btn {
    background: rgba(140,90,20,0.15);
    border: 1px solid rgba(140,90,20,0.3);
    color: #5a3000; font-family: 'Cinzel', serif;
    font-size: 11px; padding: 6px 16px;
    cursor: pointer; border-radius: 2px;
    transition: background 0.15s;
  }
  .itinerary-close-btn:hover { background: rgba(140,90,20,0.25); }

  /* Visual treatment on schedule */
  .event-bar.in-itinerary {
    box-shadow: 0 0 0 3px #2a7d52, 0 6px 20px rgba(42,125,82,0.4);
    position: relative;
    z-index: 5;
  }
  .event-bar.in-itinerary::after {
    content: '‚úì';
    position: absolute; top: 2px; left: 4px;
    font-size: 12px; color: #2a7d52;
    font-weight: 700;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }
  .event-bar.itinerary-dimmed {
    opacity: 0.15;
    filter: grayscale(0.6);
  }


  .tooltip-star-btn {
    display: inline-block;
    font-size: 18px;
    cursor: pointer;
    margin-left: 8px;
    vertical-align: middle;
    transition: transform 0.15s;
    user-select: none;
    line-height: 1;
  }
  .tooltip-star-btn:hover { transform: scale(1.3); }
  .tooltip-star-btn.faved { color: #ffd700; }
  .tooltip-star-btn:not(.faved) { color: rgba(255,255,255,0.5); }

</style>
</head>
<body>

<!-- ‚îÄ‚îÄ Inline SVG defs for reusable flourish ‚îÄ‚îÄ -->
<svg style="display:none" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <symbol id="corner-flourish" viewBox="0 0 90 90">
      <!-- Main scroll curves -->
      <path d="M5,5 Q5,32 22,32 Q38,32 38,17 Q38,9 30,9 Q23,9 23,16 Q23,22 30,20"
            fill="none" stroke="#b8892a" stroke-width="1.8" stroke-linecap="round" opacity="0.85"/>
      <path d="M5,5 Q32,5 32,22 Q32,38 17,38 Q9,38 9,30 Q9,23 16,23 Q22,23 20,30"
            fill="none" stroke="#b8892a" stroke-width="1.8" stroke-linecap="round" opacity="0.85"/>
      <!-- Tendrils -->
      <path d="M38,17 Q46,12 44,6" fill="none" stroke="#b8892a" stroke-width="1" opacity="0.6"/>
      <path d="M17,38 Q12,46 6,44" fill="none" stroke="#b8892a" stroke-width="1" opacity="0.6"/>
      <path d="M22,32 Q18,42 22,48" fill="none" stroke="#b8892a" stroke-width="1" opacity="0.5"/>
      <path d="M32,22 Q42,18 48,22" fill="none" stroke="#b8892a" stroke-width="1" opacity="0.5"/>
      <!-- Leaves -->
      <ellipse cx="41" cy="9"  rx="5"   ry="3"   fill="rgba(30,61,24,0.6)"  transform="rotate(-30,41,9)"/>
      <ellipse cx="9"  cy="41" rx="3"   ry="5"   fill="rgba(30,61,24,0.6)"  transform="rotate(30,9,41)"/>
      <ellipse cx="26" cy="22" rx="4.5" ry="2.5" fill="rgba(30,61,24,0.5)"  transform="rotate(-45,26,22)"/>
      <ellipse cx="22" cy="26" rx="2.5" ry="4.5" fill="rgba(30,61,24,0.5)"  transform="rotate(45,22,26)"/>
      <ellipse cx="44" cy="22" rx="3"   ry="2"   fill="rgba(30,61,24,0.45)" transform="rotate(-20,44,22)"/>
      <ellipse cx="22" cy="44" rx="2"   ry="3"   fill="rgba(30,61,24,0.45)" transform="rotate(20,22,44)"/>
      <!-- Gold dots -->
      <circle cx="5"  cy="5"  r="3"   fill="#c9870a"/>
      <circle cx="44" cy="6"  r="2"   fill="#c9870a" opacity="0.75"/>
      <circle cx="6"  cy="44" r="2"   fill="#c9870a" opacity="0.75"/>
      <circle cx="30" cy="20" r="1.5" fill="#e8c060" opacity="0.6"/>
      <circle cx="20" cy="30" r="1.5" fill="#e8c060" opacity="0.6"/>
    </symbol>
  </defs>
</svg>

<div class="page-wrapper">

  <!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
  <div class="header">
    <div class="header-rule">
      <div class="header-rule-line"></div>
      <div class="header-rule-diamond"></div>
      <div class="header-rule-line"></div>
    </div>

    <div class="header-crests">
      <!-- Left heraldic shield -->
      <svg class="crest-svg" width="52" height="62" viewBox="0 0 52 62">
        <path d="M4,4 L48,4 L48,36 Q48,56 26,60 Q4,56 4,36 Z" fill="rgba(122,21,21,0.18)" stroke="#b8892a" stroke-width="1.5"/>
        <path d="M8,8 L44,8 L44,36 Q44,52 26,56 Q8,52 8,36 Z" fill="none" stroke="#7a1515" stroke-width="0.6"/>
        <text x="26" y="40" text-anchor="middle" font-size="26" fill="#b8892a" opacity="0.9">‚ôû</text>
        <text x="26" y="53" text-anchor="middle" font-family="Cinzel,serif" font-size="6" fill="#c9870a" letter-spacing="1.5">REX</text>
      </svg>

      <div class="header-band">
        <h1><span class="drop-initial">R</span>enaissance Faire</h1>
        <div class="header-subtitle">‚ú¶ &nbsp; Master Performance Schedule &nbsp; ‚ú¶</div>
      </div>

      <!-- Right heraldic shield -->
      <svg class="crest-svg" width="52" height="62" viewBox="0 0 52 62">
        <path d="M4,4 L48,4 L48,36 Q48,56 26,60 Q4,56 4,36 Z" fill="rgba(30,61,24,0.18)" stroke="#b8892a" stroke-width="1.5"/>
        <path d="M8,8 L44,8 L44,36 Q44,52 26,56 Q8,52 8,36 Z" fill="none" stroke="#1e3d18" stroke-width="0.6"/>
        <text x="26" y="40" text-anchor="middle" font-size="26" fill="#2d5a27" opacity="0.9">‚öî</text>
        <text x="26" y="53" text-anchor="middle" font-family="Cinzel,serif" font-size="6" fill="#c9870a" letter-spacing="1.5">LUDI</text>
      </svg>
    </div>

    <div class="header-rule">
      <div class="header-rule-line"></div>
      <div class="header-rule-diamond"></div>
      <div class="header-rule-line"></div>
    </div>
  </div><!-- /header -->

  <!-- ‚ïê‚ïê SCROLL ‚ïê‚ïê -->
  <div style="position:relative;">

    <!-- Corner flourishes -->
    <svg style="position:absolute;top:20px;left:0;width:90px;height:90px;opacity:0.65;pointer-events:none;z-index:4;"><use href="#corner-flourish"/></svg>
    <svg style="position:absolute;top:20px;right:0;width:90px;height:90px;opacity:0.65;pointer-events:none;z-index:4;transform:scaleX(-1);"><use href="#corner-flourish"/></svg>
    <svg style="position:absolute;bottom:0;left:0;width:90px;height:90px;opacity:0.65;pointer-events:none;z-index:4;transform:scaleY(-1);"><use href="#corner-flourish"/></svg>
    <svg style="position:absolute;bottom:0;right:0;width:90px;height:90px;opacity:0.65;pointer-events:none;z-index:4;transform:scale(-1,-1);"><use href="#corner-flourish"/></svg>

    <div class="scroll-roller"></div>

    <div class="scroll-body">
      <!-- Margin vines -->
      <div class="margin-vines left">üåø‚ùßüåø‚ùßüåø‚ùßüåø‚ùßüåø</div>
      <div class="margin-vines right">üåø‚ùßüåø‚ùßüåø‚ùßüåø‚ùßüåø</div>

      <!-- Controls -->
      <div class="controls-wrap">
        <span class="controls-label">‚öî Seek</span>
        <div class="search-wrap">
          <span class="search-icon">üîç</span>
          <input type="text" id="search" placeholder="Search performances or stages‚Ä¶">
        </div>
        <button class="btn" onclick="clearSearch()">‚úï Clear</button>
        <button class="btn" onclick="scrollToNow()">‚åõ Now</button>
        <button class="filter-faves-btn" id="faveFilterBtn" onclick="toggleFaveFilter()">‚òÜ Favourites</button>
        <button class="calc-itinerary-btn" id="calcBtn" onclick="calculateItinerary()">üìã Plan My Day</button>
      </div>

      <div class="ornament-divider">
        <div class="ornament-line"></div>
        <span class="ornament-center">‚öú</span>
        <div class="ornament-line"></div>
      </div>

      <!-- Chart -->
      <div class="chart-container" id="chartContainer">
        <div class="chart-inner" id="chartInner">
          <div class="timeline-header">
            <div class="stage-label-header">Stage</div>
            <div class="time-axis" id="timeAxis"></div>
          </div>
          <div id="chartRows"></div>
        </div>
      </div>

      
  <!-- Itinerary Panel -->
  <div class="itinerary-panel" id="itineraryPanel">
    <div class="itinerary-header">‚öî Your Optimized Itinerary ‚öî</div>
    <div class="itinerary-summary" id="itinerarySummary"></div>
    <div class="itinerary-timeline" id="itineraryTimeline"></div>
    <div class="skipped-section" id="skippedSection" style="display:none;">
      <div class="skipped-header">‚ö† Could Not Fit (Time Conflicts)</div>
      <div class="skipped-list" id="skippedList"></div>
    </div>
    <div class="itinerary-actions">
      <button class="itinerary-close-btn" onclick="clearItinerary()">Clear Itinerary</button>
    </div>
  </div>


      <div class="ornament-divider">
        <div class="ornament-line"></div>
        <span class="ornament-center">‚ú¶ ¬∑ ‚ú¶ ¬∑ ‚ú¶</span>
        <div class="ornament-line"></div>
      </div>

    </div><!-- /scroll-body -->

    <div class="scroll-roller"></div>
  </div>

  
  <!-- Performer List -->
  <div class="performer-list-section" id="performerList">
    <div class="performer-list-header">The Players of Fairhaven</div>
    <div class="performer-list-sub">Tap the ‚òÜ to mark your favourites ‚Äî they will be highlighted in the schedule above</div>
    <div class="performer-grid" id="performerGrid"></div>
  </div>

  <div class="footer">All times approximate &nbsp;¬∑&nbsp; Schedule subject to change &nbsp;¬∑&nbsp; ‚öú &nbsp;¬∑&nbsp; Fare Thee Well</div>

</div><!-- /page-wrapper -->

<!-- Tooltip -->
<div class="tooltip" id="tooltip">
  <div class="tooltip-title" id="tt-title"></div>
  <div class="tooltip-meta"  id="tt-meta"></div>
  <div class="tooltip-blurb" id="tt-blurb"></div>
  <a class="tooltip-link" id="tt-link" href="#" target="_blank" rel="noopener">More Info ‚ûú</a>
  <div class="tooltip-stage" id="tt-stage"></div>
</div>

<script>
const RAW = [
  ["Royal Pavilion","The Moral Compass ‚Äì Ticket to Paradise Game","10:30","10:55"],
  ["Royal Pavilion","The Very Brief Shakespeare Company","11:00","11:25"],
  ["Royal Pavilion","The Jeste Games ‚Äì Silly Jester Competitions","11:30","12:25"],
  ["Royal Pavilion","Children's Knighting Ceremony","12:30","13:25"],
  ["Royal Pavilion","Storytime with the Queen & Contests","1:30","14:25"],
  ["Royal Pavilion","Royal Storytime with the Exeters","2:30","14:55"],
  ["Royal Pavilion","The Moral Compass ‚Äì Ticket to Paradise Game","3:00","15:25"],
  ["Royal Pavilion","The Jeste Games ‚Äì Silly Jester Competitions","3:30","15:55"],
  ["Royal Pavilion","The Moral Compass ‚Äì Ticket to Paradise Game","4:00","16:40"],
  ["Royal Pavilion","Tartanic ‚Äì Blow Up & Beaten","4:45","17:45"],
  ["Boat House Stage","The Ded Bob Sho (LC)","10:45","11:25"],
  ["Boat House Stage","Barely Balanced ‚Äì Sharp Knives & Stupid Humans","11:30","12:10"],
  ["Boat House Stage","The Ded Bob Sho (LC)","12:15","12:55"],
  ["Boat House Stage","Barely Balanced ‚Äì Sharp Knives & Stupid Humans","1:00","13:40"],
  ["Boat House Stage","The Ded Bob Sho (LC)","1:45","14:25"],
  ["Boat House Stage","Barely Balanced ‚Äì Sharp Knives & Stupid Humans","2:30","15:10"],
  ["Boat House Stage","The Ded Bob Sho (LC)","3:15","15:55"],
  ["Boat House Stage","Fiery Extravaganza","4:00","17:00"],
  ["Middleshire Stage","Heralds of MyeBunnn ‚Äì The Morning Show","10:30","10:55"],
  ["Middleshire Stage","Zilch the Torysteller ‚Äì Comic Confusion (LC)","11:00","11:25"],
  ["Middleshire Stage","Hey Nunnie Nunnie! ‚Äì Silly Songs & Counseling","11:30","12:10"],
  ["Middleshire Stage","Tartanic ‚Äì Combustible Bagpipes & Drums","12:15","12:55"],
  ["Middleshire Stage","Zilch the Torysteller ‚Äì Comic Confusion (LC)","1:00","14:00"],
  ["Middleshire Stage","Tartanic ‚Äì Combustible Bagpipes & Drums","2:15","14:40"],
  ["Middleshire Stage","Hey Nunnie Nunnie! ‚Äì Silly Songs & Counseling","2:45","14:55"],
  ["Middleshire Stage","Zilch the Torysteller ‚Äì Comic Confusion (LC)","3:00","16:00"],
  ["Middleshire Stage","Hey Nunnie Nunnie! ‚Äì Silly Songs & Counseling","4:15","17:15"],
  ["Minstrel's Roost","Iron Hill Vagabonds","11:00","11:25"],
  ["Minstrel's Roost","The Reelin' Rogues","11:30","11:55"],
  ["Minstrel's Roost","Tenacious DnD","12:00","12:55"],
  ["Minstrel's Roost","The Reelin' Rogues","1:00","13:25"],
  ["Minstrel's Roost","Tenacious DnD","1:30","13:55"],
  ["Minstrel's Roost","Iron Hill Vagabonds","2:00","14:25"],
  ["Minstrel's Roost","The Reelin' Rogues","2:30","14:55"],
  ["Minstrel's Roost","Tenacious DnD","3:00","15:55"],
  ["Minstrel's Roost","Iron Hill Vagabonds","4:00","16:25"],
  ["Minstrel's Roost","The Reelin' Rogues","4:00","16:25"],
  ["Minstrel's Roost","Tenacious DnD","4:30","17:30"],
  ["Melee Stage","The CRAIC Show","11:15","12:15"],
  ["Melee Stage","The CRAIC Show","1:15","14:15"],
  ["Melee Stage","The CRAIC Show","3:00","16:00"],
  ["Melee Stage","The CRAIC Show","4:15","17:15"],
  ["The Falconer's Heath","Tartanic ‚Äì Bagpipes for Breakfast","10:30","10:55"],
  ["The Falconer's Heath","Adam Crack ‚Äì Fire Whip Show","11:00","11:55"],
  ["The Falconer's Heath","Ancient Art of Falconry","12:00","12:55"],
  ["The Falconer's Heath","Adam Crack ‚Äì Fire Whip Show","1:00","13:55"],
  ["The Falconer's Heath","Adam Crack ‚Äì Fire Whip Show","2:00","14:55"],
  ["The Falconer's Heath","Ancient Art of Falconry","2:00","14:55"],
  ["The Falconer's Heath","Adam Crack ‚Äì Fire Whip Show","3:00","15:55"],
  ["The Falconer's Heath","Ancient Art of Falconry","4:00","16:55"],
  ["The Falconer's Heath","Adam Crack ‚Äì Fire Whip Show","5:00","18:00"],
  ["Monk's Park","Jeremy Graeff","10:30","10:55"],
  ["Monk's Park","The Toasted Clover","11:00","11:25"],
  ["Monk's Park","The Rambling Sailors","11:30","11:55"],
  ["Monk's Park","Jeremy Graeff","12:00","12:25"],
  ["Monk's Park","Yorick's Brother Jim","12:30","12:55"],
  ["Monk's Park","The Toasted Clover","1:00","13:25"],
  ["Monk's Park","The Rambling Sailors","1:30","13:55"],
  ["Monk's Park","Jeremy Graeff","2:00","14:25"],
  ["Monk's Park","Yorick's Brother Jim","2:30","14:55"],
  ["Monk's Park","The Toasted Clover","3:00","15:25"],
  ["Monk's Park","The Rambling Sailors","3:30","15:55"],
  ["Monk's Park","Yorick's Brother Jim","4:00","16:25"],
  ["Monk's Park","Jeremy Graeff","4:30","16:55"],
  ["Monk's Park","Monk's Park Sing-a-Long","5:00","18:00"],
  ["Carnivale Stage","London Broil ‚Äì Juggling Well Done","11:00","11:40"],
  ["Carnivale Stage","Lynx's Comedy Sword Swallowing Show","11:45","12:25"],
  ["Carnivale Stage","London Broil ‚Äì Juggling Well Done","12:30","13:10"],
  ["Carnivale Stage","Lynx's Comedy Sword Swallowing Show","1:15","13:55"],
  ["Carnivale Stage","London Broil ‚Äì Juggling Well Done","2:00","14:40"],
  ["Carnivale Stage","Lynx's Comedy Sword Swallowing Show","2:45","15:25"],
  ["Carnivale Stage","London Broil ‚Äì Juggling Well Done","3:30","16:10"],
  ["Carnivale Stage","Lynx's Comedy Sword Swallowing Show","4:15","17:15"],
  ["Dancing Pig Pub","Jamila Lotus Dance Carnivale","11:00","11:25"],
  ["Dancing Pig Pub","The Angels ‚Äì Nerdy, Dirty, and Flirty (LC)","11:30","12:30"],
  ["Dancing Pig Pub","Jamila Lotus Dance Carnivale","1:30","14:25"],
  ["Dancing Pig Pub","The Angels ‚Äì Nerdy, Dirty, and Flirty (LC)","2:30","14:55"],
  ["Dancing Pig Pub","Jamila Lotus Dance Carnivale","3:00","15:25"],
  ["Dancing Pig Pub","The Angels ‚Äì Nerdy, Dirty, and Flirty (LC)","3:30","15:55"],
  ["Dancing Pig Pub","Jamila Lotus Dance Carnivale","4:00","17:00"],
  ["Teatro de la Rosa","Fairhaven Morris Dancers","10:30","11:30"],
  ["Teatro de la Rosa","Heralds of MyeBunnn ‚Äì Burning in MyeBunnn","11:45","12:10"],
  ["Teatro de la Rosa","Jamila Lotus Dance Carnivale","12:15","13:15"],
  ["Teatro de la Rosa","Fairhaven Morris Dancers","1:45","14:45"],
  ["Teatro de la Rosa","Heralds of MyeBunnn ‚Äì Dingleberry Jingles","3:15","16:15"],
  ["Teatro de la Rosa","Battle for MyeBunnn","3:15","16:15"],
  ["Teatro de la Rosa","Fairhaven Morris Dancers","4:45","17:45"],
  ["Rialto Stage","Judas & Magnolia ‚Äì Underwater Escapes","11:00","11:40"],
  ["Rialto Stage","Cirque du Sewer ‚Äì Trained Cats and Rats","11:45","12:25"],
  ["Rialto Stage","Judas & Magnolia ‚Äì Underwater Escapes","12:30","13:10"],
  ["Rialto Stage","Cirque du Sewer ‚Äì Trained Cats and Rats","1:15","13:55"],
  ["Rialto Stage","Judas & Magnolia ‚Äì Underwater Escapes","2:00","14:40"],
  ["Rialto Stage","Cirque du Sewer ‚Äì Trained Cats and Rats","2:45","15:25"],
  ["Rialto Stage","Judas & Magnolia ‚Äì Underwater Escapes","3:30","16:10"],
  ["Rialto Stage","Cirque du Sewer ‚Äì Trained Cats and Rats","4:15","17:15"],
  ["Pan's Oasis","Knotty Nauticals (LC)","11:15","11:55"],
  ["Pan's Oasis","Washing Well Wenches (LC)","12:00","12:40"],
  ["Pan's Oasis","Knotty Nauticals (LC)","12:45","13:10"],
  ["Pan's Oasis","Judas & Magnolia ‚Äì Dangerous Escapades","1:15","13:25"],
  ["Pan's Oasis","Washing Well Wenches (LC)","1:30","14:10"],
  ["Pan's Oasis","Knotty Nauticals (LC)","2:15","14:55"],
  ["Pan's Oasis","Washing Well Wenches (LC)","3:00","15:40"],
  ["Pan's Oasis","Knotty Nauticals (LC)","3:45","16:25"],
  ["Pan's Oasis","Washing Well Wenches (LC)","4:30","17:30"],
  ["Fairhaven Theatre","The Renaissance Men","10:30","10:55"],
  ["Fairhaven Theatre","Jacques ze Whipper","11:00","11:40"],
  ["Fairhaven Theatre","Supernova the Swordmistress","11:45","12:25"],
  ["Fairhaven Theatre","The Sword Fighting Actor's Guild","12:30","13:10"],
  ["Fairhaven Theatre","Supernova the Swordmistress","1:15","13:55"],
  ["Fairhaven Theatre","Jacques ze Whipper","2:00","14:40"],
  ["Fairhaven Theatre","Supernova the Swordmistress","2:45","15:45"],
  ["Fairhaven Theatre","Jacques ze Whipper","3:30","16:10"],
  ["Fairhaven Theatre","The Renaissance Men ‚Äì Comedy Music Hour","4:15","16:55"],
  ["Fairhaven Theatre","Jacques ze Whipper","5:00","18:00"],
  ["The Mud Stage","Three Guys & a Bunch of Drums","10:30","11:10"],
  ["The Mud Stage","The Wyld Men ‚Äì A Muddy Comedy Adventure","11:15","11:55"],
  ["The Mud Stage","Three Guys & a Bunch of Drums","12:00","12:40"],
  ["The Mud Stage","The Wyld Men ‚Äì A Muddy Comedy Adventure","12:45","13:25"],
  ["The Mud Stage","Three Guys & a Bunch of Drums","1:30","14:10"],
  ["The Mud Stage","The Wyld Men ‚Äì A Muddy Comedy Adventure","2:15","14:55"],
  ["The Mud Stage","Three Guys & a Bunch of Drums","3:00","15:40"],
  ["The Mud Stage","The Wyld Men ‚Äì A Muddy Comedy Adventure","3:45","16:45"],
  ["The Palace Theatre","Ghazaal Beledi ‚Äì World Music & Dance","10:30","10:55"],
  ["The Palace Theatre","Tortuga Twins ‚Äì One Down, Three to Go (LC)","11:00","11:40"],
  ["The Palace Theatre","Ghazaal Beledi ‚Äì World Music & Dance","11:45","12:10"],
  ["The Palace Theatre","Gabs the Fool ‚Äì Circus of Whimsy","12:15","12:40"],
  ["The Palace Theatre","Tortuga Twins ‚Äì Two Down, Two to Go (LC)","12:45","13:25"],
  ["The Palace Theatre","Ghazaal Beledi ‚Äì World Music & Dance","1:30","13:55"],
  ["The Palace Theatre","Gabs the Fool ‚Äì Circus of Whimsy","2:00","14:25"],
  ["The Palace Theatre","Ghazaal Beledi ‚Äì World Music & Dance","2:30","14:55"],
  ["The Palace Theatre","Tortuga Twins ‚Äì Dos M√°s (LC)","3:00","15:40"],
  ["The Palace Theatre","Gabs the Fool ‚Äì Circus of Whimsy","3:45","16:10"],
  ["The Palace Theatre","Swordfighting & Stupidity (LC)","4:15","16:55"],
  ["The Palace Theatre","Gabs the Fool ‚Äì Circus of Whimsy","5:00","18:00"],
  ["King's Arena","A Joust for Royal Favor","12:00","14:20"],
  ["King's Arena","A Tournament of Champions","2:30","16:50"],
  ["King's Arena","A Joust to the Death","5:00","17:45"],
];

const START_MIN = 600, END_MIN = 1080, TOTAL_MIN = 480;

const STAGES = [
  "Royal Pavilion","Boat House Stage","Middleshire Stage","Minstrel's Roost",
  "Melee Stage","The Falconer's Heath","Monk's Park","Carnivale Stage",
  "Dancing Pig Pub","Teatro de la Rosa","Rialto Stage","Pan's Oasis",
  "Fairhaven Theatre","The Mud Stage","The Palace Theatre","King's Arena",
];

function getColor(name) {
  const lc = name.toLowerCase();
  if (lc.includes('moral compass'))        return "#b03030";
  if (lc.includes('shakespeare'))          return "#6b3fa0";
  if (lc.includes('jeste'))               return "#1a6ea8";
  if (lc.includes('knighting'))            return "#2e7d32";
  if (lc.includes('storytime'))            return "#b05a10";
  if (lc.includes('tartanic'))             return "#8b1a1a";
  if (lc.includes('ded bob'))              return "#1e4d8c";
  if (lc.includes('barely balanced'))      return "#8c4a00";
  if (lc.includes('fiery'))               return "#c04000";
  if (lc.includes('heralds'))             return "#1a6b50";
  if (lc.includes('zilch'))              return "#6b2090";
  if (lc.includes('nunnie'))             return "#7a6000";
  if (lc.includes('iron hill'))           return "#2a2a8c";
  if (lc.includes('reelin'))             return "#9c2060";
  if (lc.includes('craic'))              return "#005a8c";
  if (lc.includes('adam crack'))         return "#a04800";
  if (lc.includes('falconry'))           return "#2a6e30";
  if (lc.includes('jeremy'))             return "#6e1e6e";
  if (lc.includes('toasted clover'))     return "#4a6e00";
  if (lc.includes('rambling sailors'))   return "#006080";
  if (lc.includes("yorick"))             return "#6e3a10";
  if (lc.includes('sing-a-long'))        return "#1a1a80";
  if (lc.includes('london broil'))       return "#8c3030";
  if (lc.includes('jamila'))            return "#9c1060";
  if (lc.includes('thistle'))           return "#0a4e80";
  if (lc.includes('morris'))            return "#386e00";
  if (lc.includes('myebunnn') && !lc.includes('battle')) return "#7a5a10";
  if (lc.includes('battle'))            return "#9c1010";
  if (lc.includes('limited engagement')) return "#3a5068";
  if (lc.includes('knotty'))            return "#0a6858";
  if (lc.includes('judas'))             return "#801840";
  if (lc.includes('renaissance men'))   return "#4a2a80";
  if (lc.includes('sword fighting'))    return "#7a3010";
  if (lc.includes('supernova'))         return "#6e0e6e";
  if (lc.includes('drums'))             return "#7a2010";
  if (lc.includes('wyld men'))          return "#2e5a1e";
  if (lc.includes('ghazaal'))           return "#801040";
  if (lc.includes('tortuga'))           return "#0a4e80";
  if (lc.includes('gabs'))              return "#6a5000";
  if (lc.includes('joust to the death')) return "#a00000";
  if (lc.includes('tournament'))        return "#1a1a9c";
  if (lc.includes('joust for royal'))   return "#8c1800";
  return "#3a5068";
}

function parseMin(t) {
  const [h,m] = t.split(':').map(Number);
  return (h < 10 ? h+12 : h)*60 + m;
}
function minToTime(m) {
  const h=Math.floor(m/60), mn=m%60, h12=h>12?h-12:h, ap=h>=12?'PM':'AM';
  return `${h12}:${mn.toString().padStart(2,'0')} ${ap}`;
}
function pct(min) { return ((min-START_MIN)/TOTAL_MIN)*100; }
function lighten(hex,a) {
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  const clamp = v => Math.max(0, Math.min(255, v));
  return `#${clamp(r+a).toString(16).padStart(2,'0')}${clamp(g+a).toString(16).padStart(2,'0')}${clamp(b+a).toString(16).padStart(2,'0')}`;
}

const events = RAW.map(([stage,name,start,end])=>({
  stage,name,
  startMin:parseMin(start), endMin:parseMin(end),
  startStr:minToTime(parseMin(start)), endStr:minToTime(parseMin(end)),
  dur:parseMin(end)-parseMin(start), color:getColor(name),
}));

function renderTimeAxis() {
  const axis=document.getElementById('timeAxis');
  for(let h=10;h<=18;h++){
    const p=pct(h*60);
    const tick=document.createElement('div'); tick.className='time-tick'; tick.style.left=p+'%';
    const lbl=document.createElement('span'); lbl.className='tick-label';
    lbl.textContent=`${h>12?h-12:h}${h>=12?'PM':'AM'}`;
    const line=document.createElement('div'); line.className='tick-line';
    tick.appendChild(lbl); tick.appendChild(line); axis.appendChild(tick);
  }
}

function renderRows() {
  const container=document.getElementById('chartRows'); container.innerHTML='';
  STAGES.forEach(stage=>{
    const stageEvents=events.filter(e=>e.stage===stage);
    const row=document.createElement('div'); row.className='chart-row';
    const nameEl=document.createElement('div'); nameEl.className='stage-name'; nameEl.textContent=stage;
    const barsEl=document.createElement('div'); barsEl.className='bars-area';
    stageEvents.forEach(ev=>{
      const startP=pct(Math.max(ev.startMin,START_MIN));
      const endP=pct(Math.min(ev.endMin,END_MIN));
      const widthP=endP-startP; if(widthP<=0)return;
      const bar=document.createElement('div'); bar.className='event-bar';
      bar.style.left=startP+'%'; bar.style.width=widthP+'%';
      bar.style.background=`linear-gradient(160deg,${lighten(ev.color,35)} 0%,${ev.color} 60%)`;
      const faveKey = getEventKey(ev);
      bar.dataset.name=ev.name; bar.dataset.stage=ev.stage; bar.dataset.favekey=faveKey; bar.dataset.start=ev.startStr;
      if (isFaved(faveKey)) bar.classList.add('favorited');
      const lbl=document.createElement('span'); lbl.className='event-bar-label'; lbl.textContent=ev.name;
      bar.appendChild(lbl);
      const star=document.createElement('span'); star.className='star-overlay';
      star.textContent = isFaved(faveKey) ? '‚òÖ' : '‚òÜ';
      star.title = 'Toggle favourite';
      star.addEventListener('click', e => { e.stopPropagation(); toggleFave(faveKey); });
      bar.appendChild(star);
      bar.addEventListener('mouseenter',e=>showTooltip(e,ev));
      bar.addEventListener('mousemove',e=>moveTooltip(e));
      bar.addEventListener('mouseleave',()=>{ tooltipHideTimer=setTimeout(hideTooltip,200); });
      barsEl.appendChild(bar);
    });
    row.appendChild(nameEl); row.appendChild(barsEl); container.appendChild(row);
  });
}

const tooltip=document.getElementById('tooltip'),ttTitle=document.getElementById('tt-title'),
      ttMeta=document.getElementById('tt-meta'),ttStage=document.getElementById('tt-stage');


const PERFORMER_INFO = {
  'ded bob': {
    blurb: 'Bob is dead ‚Äî but he\'s funnier than ever. The Ded Bob Sho features Smuj, a silent masked figure, manipulating a snarky skeleton puppet named Bob who insults the audience and drafts unwitting volunteers as his "Bob Zombies." A vaudeville-meets-Shakespeare comedy classic on the ren faire circuit since 1988.',
    url: 'http://www.dedbob.com/'
  },
  'barely balanced': {
    blurb: 'Small, Medium, and Large are an award-winning acrobatic comedy trio who dive through fire, hurl machetes, and test the limits of natural selection ‚Äî all while cracking jokes. Over 20 years of hilarious, family-friendly danger.',
    url: 'https://barelybalanced.com/'
  },
  'tartanic': {
    blurb: 'Voted Best Music Group at the Renaissance Festival Royal Choice Entertainment Awards every year from 2010‚Äì2023. Tartanic features two World Champion Highland Bagpipers, world percussionists, and the McCrackin sisters in a show equal parts rock concert, dance party, and Celtic spectacle.',
    url: 'https://www.tartanic.net/'
  },
  'adam crack': {
    blurb: 'Adam Winrich holds multiple Guinness World Records for whip cracking, including the longest whip ever cracked (216 feet). His Fire Whip Show mixes high-energy single and double-whip routines ‚Äî balloon popping, candle snuffing, flower cutting ‚Äî with dry humor and audience participation.',
    url: 'https://www.winrichwhips.com/'
  },
  'tortuga twins': {
    blurb: 'Playfully bawdy and wildly interactive, the Tortuga Twins (actually three of them!) present audience-driven comedic tales ranging from family-friendly Robin Hood to the considerably racier Big Bad Wolf. A ren faire staple for decades.',
    url: 'https://www.tortugatwins.com/'
  },
  'zilch': {
    blurb: 'Terry Foy is a master of spoonerisms ‚Äî swapping consonants at lightning speed to mangle beloved fairy tales into comic chaos. Rittle Led Hiding Rood and Jomeo & Ruliet by Spilliam Wakesheare are audience favorites. He\'s been torystelling for over four decades.',
    url: null
  },
  'ghazaal beledi': {
    blurb: 'Ghazaal Beledi (Arabic for Dancing Gazelle) is a Phoenix-based world fusion and tribal belly dance troupe performing styles from Middle Eastern belly dance, Bhangra, Bollywood, Flamenco, and Irish dance ‚Äî sometimes with swords and fire.',
    url: 'https://www.ghazaalbeledi.com/'
  },
  'gabs the fool': {
    blurb: 'A second-generation Renaissance Festival performer, Gabriel Cole-Brant is a one-man silent circus. Without saying a single word, Gabs combines unicycling, juggling, magic, rope walking, and heartfelt clowning into a show that delights all ages.',
    url: 'https://gabsthefool.com/'
  },
  'iron hill vagabonds': {
    blurb: 'An acoustic music duo performing a mix of traditional and original Renaissance, Celtic, Folk, and Bluegrass tunes. Brothers Ehrich and Mark Gauvin bring a wandering minstrel energy to the festival lanes.',
    url: null
  },
  'craic': {
    blurb: 'The CRAIC Show is a wild musical experience ‚Äî traditional Medieval, Renaissance, and Irish tunes on ancient instruments driven by thunderous drums. This is music you\'ll feel in your chest as much as hear.',
    url: null
  },
  'falconry': {
    blurb: 'A live birds-of-prey demonstration featuring hawks, owls, falcons, and more in free flight above and around the audience. Experience the 5,000-year-old Sport of Kings up close.',
    url: null
  },
  'jamila lotus': {
    blurb: 'The Jamila Lotus Dance Carnivale performs fast-paced original choreography and feats of balance and daring, featuring the live music of their Band of Eternal Souls.',
    url: null
  },
  'fiery extravaganza': {
    blurb: 'A spectacular end-of-day fire performance showcasing the full range of fire arts ‚Äî the perfect blazing finale to a day at the faire.',
    url: null
  },
  'heralds': {
    blurb: 'The Heralds of MyeBunnn bring morning energy and comedy to kick off the festival day, mixing announcements, audience interaction, and theatrical antics in true herald fashion.',
    url: null
  },
  'renaissance men': {
    blurb: 'A comedy music group performing hilarious spooneristic songs and audience-favorite sing-alongs with a medieval twist.',
    url: null
  },
  'judas': {
    blurb: 'Judas and Magnolia are an award-winning husband-and-wife team of illusionists who blend death-defying escape stunts, theatrical seances, physical extremity, and comedy into unforgettable live experiences.',
    url: 'https://judasandmagnolia.com/'
  },
  'supernova': {
    blurb: 'Trained by Cirque du Soleil coaches, Supernova the Strongwoman collaborates with the audience to fuel insane strength stunts, daredevil acrobatics, and the wanton destruction of perfectly good steel.',
    url: null
  },
  'wyld men': {
    blurb: 'A muddy, madcap comedy adventure show that embraces the glorious chaos of the Mud Stage. Expect laughs, surprises, and possibly some splatter.',
    url: null
  },
  'drums': {
    blurb: 'Three Guys & a Bunch of Drums deliver a high-energy percussion performance that gets the crowd moving. Raw rhythmic power with a comedic edge.',
    url: null
  },
  'london broil': {
    blurb: 'London Broil is a skilled juggling act served well-done ‚Äî tossing blades, torches, and plenty of crowd-pleasing humor.',
    url: null
  },
  'joust to the death': {
    blurb: 'The day\'s climactic finale ‚Äî armored knights on horseback battle with ten-foot lances in a realistic recreation of a fight to the death. Tempers flare, lances splinter, and the crowd roars in the 5,000-seat King\'s Arena.',
    url: 'https://thejousters.com'
  },
  'tournament of champions': {
    blurb: 'The realm\'s finest knights compete in a three-part mounted tournament, testing skill, courage, and horsemanship before a roaring crowd in the King\'s Arena.',
    url: 'https://thejousters.com'
  },
  'joust for royal': {
    blurb: 'Armored knights thunder across the arena on horseback, lances leveled, competing for the honor and favor of the Royal Court. The Age of Chivalry is alive!',
    url: 'https://thejousters.com'
  },
  'knotty': {
    blurb: 'Knotty Nauticals is a pirate-themed comedy stunt show featuring rope walking, fire eating, and swashbuckling humor with a salty maritime twist.',
    url: null
  },
  'morris': {
    blurb: 'Fairhaven Morris Dancers perform traditional English folk dances ‚Äî lively choreographed figures danced to live music, a centuries-old tradition revived for the faire.',
    url: null
  },
  'reelin': {
    blurb: 'The Reelin\' Rogues are a roving band of raucous musicians bringing folk, sea shanties, and bawdy tunes to the festival stages and lanes.',
    url: null
  },
  'nunnie': {
    blurb: 'Since 1994, Shannon O\'Brien and Dana McCain have played Mother Redempta and Sister Philomena Claire ‚Äî two irreverent nuns who crack jokes, sing ukulele-fueled songs, and offer hilariously unsolicited counseling to audience members.',
    url: 'http://www.heynunnienunnie.com/'
  },
  'toasted clover': {
    blurb: 'Sam Kesler is a nationally touring musician-comedian performing a rowdy blend of traditional Irish drinking songs, original tunes, and comedy. A classically trained ukulele player with a gift for turning a pub tune into a full audience sing-along.',
    url: 'https://samkesler.bandcamp.com/'
  },
  'rambling sailors': {
    blurb: 'Gregg and Susan Csikos are veteran faire musicians delivering sea shanties, nautical ballads, and piratical ditties with tight harmonies and 25+ years of experience on the circuit. Not pirates. Definitely not pirates.',
    url: 'https://ramblingsailorsmusic.com/'
  },
  'jeremy graeff': {
    blurb: 'Jeremy Graeff has traveled far and wide collecting Medieval and Renaissance songs. Joined by multi-instrumentalist Mark Williams, every show is an adventure through the magical melodies and bewitching ballads of the European past.',
    url: 'https://jeremygraeffmusic.com/'
  },
  'moral compass': {
    blurb: 'Ticket to Paradise is a totally-not-rigged improv comedy game show hosted by Cardinal Guido Consigliere ‚Äî unqualified, with the best intentions. Featuring anchoresses, friars, and surprise clergymen competing in Divine Knowledge challenges.',
    url: null
  },
  'very brief shakespeare': {
    blurb: 'Rollicking, condensed versions of the Bard\'s most popular plays ‚Äî laugh-packed twenty-minute performances of Hamlet, Romeo & Juliet, and more, made hilarious and accessible for all ages.',
    url: null
  },
  'jeste games': {
    blurb: 'A silly audience-driven jester competition where festival-goers battle in absurd fool challenges. Expect slapstick, volunteers in fool\'s caps, and the noble pursuit of who can be most delightfully ridiculous.',
    url: null
  },
  'knighting': {
    blurb: 'A beloved free tradition ‚Äî children kneel before the Queen and receive an official knighthood ceremony. Young knights rise to serve the realm with honor, bravery, and the occasional turkey leg.',
    url: null
  },
  'storytime with the queen': {
    blurb: 'Her Majesty Queen Katherine invites young fairgoers and families for a royal storytelling session ‚Äî tales of chivalry and wonder told in proper regal style.',
    url: null
  },
  'royal storytime': {
    blurb: 'Queen Katherine and the Royal Family of the House of Exeter share stories and meet with festival guests in an intimate royal audience.',
    url: null
  },
  'limited engagement': {
    blurb: 'A rotating roster of world-class acts appearing for a limited run only ‚Äî escape artists, knife throwers, whip crackers, and one-woman circus shows. Each act is unique; when they\'re gone, they\'re gone.',
    url: 'https://arizona.renfestinfo.com/entertainment'
  },
  'sword fighting': {
    blurb: 'The Sword Fighting Actor\'s Guild combines live stage combat with theatrical performance ‚Äî choreographed duels, witty repartee, and swashbuckling flair bringing Renaissance swordsmanship to life.',
    url: null
  },
  'thistle': {
    blurb: 'Thistle & Thorn is a musical duo weaving Celtic folk, original compositions, and close harmonies into an intimate acoustic performance at the Dancing Pig Pub.',
    url: null
  },
  'yorick': {
    blurb: 'A comedic solo performance paying tribute to Hamlet\'s most famous skull ‚Äî wordplay, physical comedy, and absurdist humor as the long-suffering companion of the melancholy Dane.',
    url: null
  },
  'sing-a-long': {
    blurb: 'A rousing community sing-along bringing the whole crowd together at the end of the day. No experience required ‚Äî just enthusiasm and perhaps a frothy beverage.',
    url: null
  },
  'battle': {
    blurb: 'An epic theatrical battle for the soul of MyeBunnn! The Heralds and their allies take the stage in a dramatic, comedic showdown that brings the festival storyline to a boisterous climax.',
    url: null
  },

  'Judas & Magnolia ‚Äì Underwater Escapes': {
    blurb: 'Death-defying underwater escape artistry combining magic, danger, and breathtaking suspense.',
    url: ''
  },
  'Cirque du Sewer ‚Äì Trained Cats and Rats': {
    blurb: 'A hilariously bizarre circus act featuring remarkably talented felines and rodents in theatrical mayhem.',
    url: ''
  },

  'Jacques ze Whipper': {
    blurb: 'A master of the bullwhip, combining precision, comedy, and danger in an unforgettable performance.',
    url: 'https://www.jacqueszewhipper.com'
  },
};

function getPerformerInfo(name) {
  const lc = name.toLowerCase();
  // Check specific multi-word keys first (longer = more specific)
  const keys = Object.keys(PERFORMER_INFO).sort((a,b) => b.length - a.length);
  for (const key of keys) {
    if (lc.includes(key)) return PERFORMER_INFO[key];
  }
  return null;
}

function showTooltip(e,ev){
  ttTitle.textContent=ev.name;
  ttMeta.innerHTML=`‚è∞ ${ev.startStr} ‚Äì ${ev.endStr} &nbsp;¬∑&nbsp; ‚è± ${ev.dur} min`;
  const info = getPerformerInfo(ev.name);
  const ttBlurb = document.getElementById('tt-blurb');
  const ttLink  = document.getElementById('tt-link');
  if (info && info.blurb) {
    ttBlurb.textContent = info.blurb;
    ttBlurb.style.display = 'block';
  } else {
    ttBlurb.style.display = 'none';
  }
  if (info && info.url) {
    ttLink.href = info.url;
    ttLink.style.display = 'inline-block';
  } else {
    ttLink.style.display = 'none';
  }
  ttStage.textContent=ev.stage; tooltip.classList.add('visible'); moveTooltip(e);
}
function moveTooltip(e){
  const x=e.clientX+14,y=e.clientY-10,tw=tooltip.offsetWidth,th=tooltip.offsetHeight;
  tooltip.style.left=(x+tw>window.innerWidth?e.clientX-tw-14:x)+'px';
  tooltip.style.top=(y+th>window.innerHeight?e.clientY-th-10:y)+'px';
}
let tooltipHideTimer=null;
function hideTooltip(){ tooltip.classList.remove('visible'); }
tooltip.addEventListener('mouseenter',()=>{ clearTimeout(tooltipHideTimer); });
tooltip.addEventListener('mouseleave',()=>{ hideTooltip(); });

document.getElementById('search').addEventListener('input',function(){applySearch(this.value.trim().toLowerCase());});
function applySearch(q){
  document.querySelectorAll('.event-bar').forEach(bar=>{
    if(!q){ bar.classList.remove('dimmed','highlighted'); return; }
    const m=bar.dataset.name.toLowerCase().includes(q)||bar.dataset.stage.toLowerCase().includes(q);
    bar.classList.toggle('dimmed',!m); bar.classList.toggle('highlighted',m);
  });
}
function clearSearch(){ document.getElementById('search').value=''; applySearch(''); }
function scrollToNow(){
  const n=getNowMin(); if(n<START_MIN||n>END_MIN)return;
  const p=pct(n),inner=document.getElementById('chartInner'),cont=document.getElementById('chartContainer');
  cont.scrollTo({left:(inner.offsetWidth*p/100)-cont.offsetWidth/2,behavior:'smooth'});
}
function getNowMin(){ const n=new Date(); return n.getHours()*60+n.getMinutes(); }
function renderNowLine(){
  const n=getNowMin(); if(n<START_MIN||n>END_MIN)return;
  const p=pct(n);
  document.querySelectorAll('.bars-area').forEach(area=>{
    const line=document.createElement('div'); line.className='now-line'; line.style.left=p+'%'; area.appendChild(line);
  });
  const axis=document.getElementById('timeAxis');
  const lbl=document.createElement('div');
  Object.assign(lbl.style,{position:'absolute',left:p+'%',top:'2px',transform:'translateX(-50%)',
    fontFamily:'Cinzel,serif',fontSize:'8px',color:'rgba(175,18,18,0.95)',letterSpacing:'1px',whiteSpace:'nowrap'});
  lbl.textContent='‚ñº NOW'; axis.appendChild(lbl);
  const nl=document.createElement('div');
  Object.assign(nl.style,{position:'absolute',left:p+'%',top:'0',width:'2px',height:'100%',
    background:'rgba(175,18,18,0.75)',pointerEvents:'none'}); axis.appendChild(nl);
}



// ‚îÄ‚îÄ STARRED (PRIORITY) STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let starred = new Set(JSON.parse(localStorage.getItem('arfStarred') || '[]'));

function saveStarred() {
  try { localStorage.setItem('arfStarred', JSON.stringify([...starred])); } catch(e){}
}

function isStarred(key) { return starred.has(key); }

function toggleStar(key) {
  if (starred.has(key)) starred.delete(key);
  else starred.add(key);
  saveStarred();
  renderRows();
  renderPerformerGrid();
}

// Override toggleFave to also manage starred state
const originalToggleFave = toggleFave;
function toggleFave(key) {
  originalToggleFave(key);
  // When favoriting, also star it by default
  if (favourites.has(key) && !starred.has(key)) {
    starred.add(key);
    saveStarred();
  }
  // When un-favoriting, also un-star
  if (!favourites.has(key) && starred.has(key)) {
    starred.delete(key);
    saveStarred();
  }
}

// ‚îÄ‚îÄ FAVOURITES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let favourites = new Set(JSON.parse(localStorage.getItem('arfFaves') || '[]'));
let faveFilterOn = false;

function saveFaves() {
  try { localStorage.setItem('arfFaves', JSON.stringify([...favourites])); } catch(e){}
}

function getEventKey(ev) {
  // Key by performer base name (strip subtitle variants)
  return ev.name.toLowerCase().replace(/[‚Äì‚Äî].*/,'').trim();
}

function toggleFave(key) {
  if (favourites.has(key)) favourites.delete(key);
  else favourites.add(key);
  saveFaves();
  renderRows();
  renderPerformerGrid();
  applyFaveFilter();
}

function isFaved(key) { return favourites.has(key); }

function toggleFaveFilter() {
  faveFilterOn = !faveFilterOn;
  document.getElementById('faveFilterBtn').classList.toggle('active', faveFilterOn);
  applyFaveFilter();
}

function applyFaveFilter() {
  document.querySelectorAll('.event-bar').forEach(bar => {
    if (!faveFilterOn || favourites.size === 0) {
      bar.classList.remove('fave-dimmed');
      return;
    }
    const key = bar.dataset.favekey;
    bar.classList.toggle('fave-dimmed', !favourites.has(key));
  });
}

// ‚îÄ‚îÄ PERFORMER GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildPerformerCatalog() {
  // Unique performers with their times and stages
  const catalog = {};
  events.forEach(ev => {
    const key = getEventKey(ev);
    if (!catalog[key]) {
      catalog[key] = { name: ev.name.replace(/[‚Äì‚Äî].*/,'').trim(), color: ev.color, times: [], key };
    }
    catalog[key].times.push({ stage: ev.stage, start: ev.startStr });
  });
  return Object.values(catalog).sort((a,b) => a.name.localeCompare(b.name));
}

function renderPerformerGrid() {
  const grid = document.getElementById('performerGrid');
  if (!grid) return;
  const catalog = buildPerformerCatalog();
  grid.innerHTML = '';
  catalog.forEach(perf => {
    const info = getPerformerInfo(perf.name);
    const faved = isFaved(perf.key);
    const card = document.createElement('div');
    card.className = 'performer-card' + (faved ? ' is-fave' : '');
    card.dataset.key = perf.key;

    const colorBar = document.createElement('div');
    colorBar.className = 'card-color-bar';
    colorBar.style.background = perf.color;

    const header = document.createElement('div');
    header.className = 'card-header';

    const titleEl = document.createElement('div');
    titleEl.className = 'card-title';
    titleEl.textContent = perf.name;

    const starBtn = document.createElement('button');
    starBtn.className = 'card-star-btn';
    starBtn.textContent = faved ? '‚òÖ' : '‚òÜ';
    starBtn.title = faved ? 'Remove from favourites' : 'Add to favourites';
    starBtn.setAttribute('type', 'button');
    starBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleFave(perf.key);
    });

    header.appendChild(titleEl);
    header.appendChild(starBtn);

    const stages = [...new Set(perf.times.map(t => t.stage))].join(', ');
    const meta = document.createElement('div');
    meta.className = 'card-meta';
    meta.textContent = 'üìç ' + stages;

    const blurbEl = document.createElement('div');
    blurbEl.className = 'card-blurb';
    blurbEl.textContent = info ? info.blurb : 'A featured performance at the Arizona Renaissance Festival.';

    card.appendChild(colorBar);
    card.appendChild(header);
    card.appendChild(meta);
    card.appendChild(blurbEl);

    if (info && info.url) {
      const link = document.createElement('a');
      link.className = 'card-link';
      link.href = info.url;
      link.target = '_blank';
      link.rel = 'noopener';
      link.textContent = 'Learn More ‚ûú';
      card.appendChild(link);
    }

    const timePills = document.createElement('div');
    timePills.className = 'card-times';
    perf.times.forEach(t => {
      const pill = document.createElement('span');
      pill.className = 'card-time-pill';
      pill.textContent = t.start;
      timePills.appendChild(pill);
    });
    card.appendChild(timePills);

    grid.appendChild(card);
  });
}


// ‚îÄ‚îÄ ITINERARY CALCULATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let calculatedItinerary = [];

function parseTimeStr(s) {
  const [h, m] = s.split(':').map(Number);
  return (h < 10 ? h + 12 : h) * 60 + m;
}

function timeStrFromMin(min) {
  const h = Math.floor(min / 60);
  const m = min % 60;
  return `${h}:${m.toString().padStart(2,'0')}`;
}

function calculateItinerary() {
  if (favourites.size === 0) {
    alert('Please star some performances first using the ‚òÜ icons!');
    return;
  }

  // Gather all favorited events
  const favedEvents = events.filter(ev => favourites.has(getEventKey(ev)));
  
  // Separate into priority (starred) and regular favorites
  const priorityEvents = favedEvents.filter(ev => isStarred(getEventKey(ev)));
  const regularEvents = favedEvents.filter(ev => !isStarred(getEventKey(ev)));
  
  // Sort by start time
  priorityEvents.sort((a, b) => a.startMin - b.startMin);
  regularEvents.sort((a, b) => a.startMin - b.startMin);

  // Greedy algorithm: fit priority events first, then regular
  const selected = [];
  let lastEnd = 0;
  let lastStage = null;

  // Process priority events first
  priorityEvents.forEach(ev => {
    const bufferNeeded = (lastStage && lastStage !== ev.stage) ? 10 : 5;
    const earliestStart = lastEnd + bufferNeeded;
    
    if (ev.startMin >= earliestStart) {
      selected.push(ev);
      lastEnd = ev.endMin;
      lastStage = ev.stage;
    }
  });

  // Then fit in regular favorites where they don't conflict
  regularEvents.forEach(ev => {
    const bufferNeeded = (lastStage && lastStage !== ev.stage) ? 10 : 5;
    
    // Check if this event conflicts with any selected event
    let conflicts = false;
    for (let sel of selected) {
      const gap = Math.abs(ev.startMin - sel.endMin);
      const sameStage = ev.stage === sel.stage;
      const needed = sameStage ? 5 : 10;
      
      // Check for overlap
      if (!(ev.endMin <= sel.startMin || ev.startMin >= sel.endMin)) {
        conflicts = true;
        break;
      }
      // Check if too close
      if (ev.startMin >= sel.startMin && ev.startMin < sel.endMin + needed) {
        conflicts = true;
        break;
      }
      if (sel.startMin >= ev.startMin && sel.startMin < ev.endMin + needed) {
        conflicts = true;
        break;
      }
    }
    
    if (!conflicts) {
      selected.push(ev);
    }
  });

  // Re-sort selected by start time
  selected.sort((a, b) => a.startMin - b.startMin);

  const skipped = favedEvents.filter(ev => !selected.includes(ev));
  
  calculatedItinerary = selected;
  renderItineraryPanel(selected, skipped);
  applyItineraryVisualization();
  
  // Scroll to panel
  document.getElementById('itineraryPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderItineraryPanel(selected, skipped) {
  const panel = document.getElementById('itineraryPanel');
  const summary = document.getElementById('itinerarySummary');
  const timeline = document.getElementById('itineraryTimeline');
  const skippedSection = document.getElementById('skippedSection');
  const skippedList = document.getElementById('skippedList');

  if (selected.length === 0) {
    panel.classList.remove('visible');
    return;
  }

  summary.innerHTML = `<span class="count">${selected.length} performances</span> scheduled from ${selected[0].startStr} to ${timeStrFromMin(selected[selected.length-1].endMin)}`;
  
  if (skipped.length > 0) {
    summary.innerHTML += ` ¬∑ <span class="skipped">${skipped.length} skipped due to conflicts</span>`;
  }

  timeline.innerHTML = '';
  selected.forEach((ev, i) => {
    const item = document.createElement('div');
    item.className = 'itinerary-item';
    item.style.setProperty('--color', ev.color);
    item.innerHTML = `
      <div class="itinerary-number">${i + 1}</div>
      <div class="itinerary-time">${ev.startStr} ‚Äì ${timeStrFromMin(ev.endMin)}</div>
      <div class="itinerary-details">
        <div class="itinerary-name">${ev.name}</div>
        <div class="itinerary-location">üìç ${ev.stage}</div>
      </div>
    `;
    item.querySelector('::before') && (item.style.setProperty('--bar-color', ev.color));
    // Add color bar via inline style
    item.style.borderLeft = `4px solid ${ev.color}`;
    timeline.appendChild(item);
  });

  if (skipped.length > 0) {
    skippedSection.style.display = 'block';
    skippedList.innerHTML = skipped.map(ev => `‚Ä¢ ${ev.name} (${ev.startStr} @ ${ev.stage})`).join('<br>');
  } else {
    skippedSection.style.display = 'none';
  }

  panel.classList.add('visible');
}

function applyItineraryVisualization() {
  document.querySelectorAll('.event-bar').forEach(bar => {
    bar.classList.remove('in-itinerary', 'itinerary-dimmed');
  });

  if (calculatedItinerary.length === 0) return;

  // Create set of selected events by stage|name|start
  const selectedKeys = new Set(calculatedItinerary.map(ev => `${ev.stage}|${ev.name}|${ev.startStr}`));

  document.querySelectorAll('.event-bar').forEach(bar => {
    const stage = bar.dataset.stage;
    const name = bar.dataset.name;
    const start = bar.dataset.start;
    const key = `${stage}|${name}|${start}`;
    
    if (selectedKeys.has(key)) {
      bar.classList.add('in-itinerary');
    } else {
      bar.classList.add('itinerary-dimmed');
    }
  });
}

function clearItinerary() {
  calculatedItinerary = [];
  document.getElementById('itineraryPanel').classList.remove('visible');
  
  // Remove all itinerary visual classes
  document.querySelectorAll('.event-bar').forEach(bar => {
    bar.classList.remove('in-itinerary', 'itinerary-dimmed');
  });
  
  // Reapply favorite filter if it's on
  if (faveFilterOn) {
    applyFaveFilter();
  }
}

renderTimeAxis(); renderRows(); renderNowLine(); renderPerformerGrid();
</script>
</body>
</html>
